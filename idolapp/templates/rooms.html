<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>推し活コミュニティ - 部屋一覧</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="{{ url_for('static', filename='firebase-auth.js') }}"></script>
    <style>
        body {
            background: linear-gradient(120deg, #fff8e1 0%, #ffe082 100%);
            min-height: 100vh;
            font-family: 'M PLUS Rounded 1c', 'Meiryo', 'Segoe UI', sans-serif;
            color: #444;
        }
        .rooms-container {
            background: #fffbe7;
            border-radius: 28px;
            box-shadow: 0 8px 32px #ffe08255;
            padding: 44px 24px 32px 24px;
            width: 100%;
            max-width: 540px;
            margin: 48px auto 0 auto;
        }
        h1 {
            font-weight: bold;
            color: #ffb300;
            letter-spacing: 2px;
            margin-bottom: 22px;
            text-align: center;
            font-size: 1.7em;
            text-shadow: 0 2px 8px #fffbe7, 0 0px 2px #ffb300;
            font-family: 'M PLUS Rounded 1c', 'Meiryo', sans-serif;
        }
        .btn-pop {
            background: linear-gradient(90deg, #ffe082 0%, #ffb300 100%);
            color: #fff;
            font-weight: bold;
            border: none;
            border-radius: 18px;
            box-shadow: 0 2px 8px #ffe08244;
            transition: transform 0.1s, box-shadow 0.1s, background 0.2s;
            font-size: 1.1em;
            padding: 0.7em 1.5em;
            margin-bottom: 10px;
        }
        .btn-pop:hover, .btn-pop:active {
            transform: scale(1.04);
            background: linear-gradient(90deg, #ffb300 0%, #ffe082 100%);
        }
        .btn-link-pop {
            color: #ffb300;
            font-weight: bold;
            text-decoration: none;
            margin-bottom: 18px;
            display: inline-block;
            transition: color 0.2s;
            font-size: 1.08em;
            letter-spacing: 1px;
        }
        .btn-link-pop:hover {
            color: #ffb300;
            text-decoration: underline;
        }
        #recommend-area {
            margin-bottom: 18px;
        }
        #recommend-rooms a {
            display: block;
            margin-bottom: 6px;
        }
        #search-results a {
            display: block;
            margin-bottom: 6px;
        }
        #status {
            margin-top: 18px;
            color: #e74c3c;
            font-weight: bold;
            min-height: 1.5em;
        }
        .profile-link {
            text-align: right;
            margin-bottom: 12px;
        }
        .profile-link a {
            margin-left: 6px;
        }
        @media (max-width: 600px) {
            .rooms-container {
                border-radius: 0;
                padding: 24px 4vw 18px 4vw;
                margin: 0;
            }
            h1 {
                font-size: 1.2em;
            }
            .btn-pop {
                font-size: 1em;
                padding: 0.7em 1.2em;
            }
        }
    </style>
    <link href="https://fonts.googleapis.com/css2?family=M+PLUS+Rounded+1c:wght@700&display=swap" rel="stylesheet">
    <script>
        let allRooms = [];
        let myUid = localStorage.getItem('uid');

        // おすすめ部屋3つランダム表示
        function showRecommendRooms() {
            const filtered = allRooms;
            // シャッフル
            for (let i = filtered.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [filtered[i], filtered[j]] = [filtered[j], filtered[i]];
            }
            const recommend = filtered.slice(0, 3);
            const area = document.getElementById('recommend-rooms');
            area.innerHTML = '';
            if (recommend.length === 0) {
                area.innerHTML = '<div>おすすめ部屋はありません</div>';
                return;
            }
            recommend.forEach(room => {
                const a = document.createElement('a');
                a.href = `/room/${room.id}`;
                a.innerText = room.name;
                a.className = "btn-link-pop";
                area.appendChild(a);
            });
        }

        // 検索
        function searchRooms(keyword) {
            const resultsDiv = document.getElementById('search-results');
            if (!keyword) {
                resultsDiv.innerHTML = '';
                return;
            }
            const matched = allRooms.filter(room => room.name.includes(keyword));
            resultsDiv.innerHTML = '';
            if (matched.length === 0) {
                resultsDiv.innerHTML = '<div>該当する部屋がありません</div>';
                return;
            }
            matched.forEach(room => {
                const a = document.createElement('a');
                a.href = `/room/${room.id}`;
                a.innerText = room.name;
                a.className = "btn-link-pop";
                resultsDiv.appendChild(a);
            });
        }

        function loadRooms() {
            fetch('/api/rooms')
            .then(res => res.json())
            .then(rooms => {
                allRooms = rooms;
                showRecommendRooms();
            });
        }
        window.createRoom = function() {
            const name = prompt('作成する部屋の名前を入力してください');
            if (!name) return;
            fetch('/api/rooms', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    name: name,
                    creator_uid: myUid
                })
            })
            .then(res => res.json())
            .then(data => {
                if (data.error) {
                    alert('エラー: ' + data.error);
                } else {
                    loadRooms();
                }
            });
        }
        window.signOut = function() {
            firebase.auth().signOut().then(() => {
                window.location.href = '/';
            });
        }
        firebase.auth().onAuthStateChanged(user => {
            if (user) {
                loadRooms();
            } else {
                window.location.href = '/';
            }
        });

        window.addEventListener('DOMContentLoaded', () => {
            document.getElementById('searchInput').addEventListener('input', function() {
                searchRooms(this.value.trim());
            });
        });
    </script>
</head>
<body>
    <div class="rooms-container">
        <h1>部屋一覧</h1>
        <div class="d-flex gap-2 mb-3">
            <button onclick="createRoom()" class="btn-pop flex-fill">新規部屋作成</button>
            <a href="/" class="btn-pop flex-fill" style="background: #ffe082; color: #ffb300; text-align:center; display:flex; align-items:center; justify-content:center; text-decoration:none;">Homeへ戻る</a>
        </div>
        <!-- おすすめ部屋 -->
        <div id="recommend-area" class="mb-3">
            <div style="font-weight:bold; color:#ffb300; margin-bottom:6px;">おすすめの部屋</div>
            <div id="recommend-rooms"></div>
        </div>
        <!-- 検索 -->
        <div class="mb-3">
            <input type="text" id="searchInput" class="form-control" placeholder="部屋名で検索">
            <div id="search-results" class="mt-2"></div>
        </div>
        <div id="status"></div>
    </div>
</body>
</html>